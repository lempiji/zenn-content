---
title: "Dè¨€èªã«ãŠã‘ã‚‹ã‚³ãƒ”ãƒ¼ã‚’å°‘ã—ã ã‘ç†è§£ã™ã‚‹"
emoji: "ğŸ”"
type: "tech"
topics: ["dlang", "performance", "compiler"]
published: true
---


# ã¯ã˜ã‚ã«

ã“ã¡ã‚‰ã¯ã€Dè¨€èª Advent Calendar 2025 14æ—¥ç›®ã®è¨˜äº‹ã¨ãªã‚Šã¾ã™ã€‚

https://qiita.com/advent-calendar/2025/dlang

ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«é–¢ã—ã¦ã€ã‚ˆãã€Œã‚³ãƒ”ãƒ¼ã¯é‡ã„ã‹ã‚‰é¿ã‘ã‚ˆã†ã€ã¨è¨€ã‚ã‚Œã¾ã™ã€‚
ã—ã‹ã—é¿ã‘ã‚‹ã‚‚ä½•ã‚‚ã€ã‚³ãƒ”ãƒ¼ã¨è¨€ã†ã®ã¯ãªã‹ãªã‹ã‚„ã‚„ã“ã—ãã€ã©ã“ã§ã‚³ãƒ”ãƒ¼ãŒèµ·ãã¦ã‚‹ã®ã‹ã‚¤ãƒã‚¤ãƒã‚ã‹ã‚‰ãªã‹ã£ãŸã‚Šã€ã‚³ãƒ”ãƒ¼æ™‚ã®æŒ™å‹•ãŒã‚ˆãåˆ†ã‹ã‚‰ãªããªã£ãŸã‚Šã—ãŒã¡ã‹ã¨æ€ã„ã¾ã™ã€‚
ã¨ã„ã†ã‹ã€ã„ã¡ã„ã¡å…¨éƒ¨ã¯è¿½ã£ã¦ã‚‰ã‚Œã¾ã›ã‚“ã­ã€‚å¤§æŠµæ•°ãŒå¤šã„ã®ã§ã€‚

ãã“ã§ä»Šå›ã¯ã€ã“ã®æ§‹é€ ä½“ã®ã‚³ãƒ”ãƒ¼ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã€Dè¨€èªã®ä»•æ§˜äº¤ãˆãªãŒã‚‰æ··ä¹±ã—ãŒã¡ãªãƒã‚¤ãƒ³ãƒˆã‚’ç°¡å˜ã«æ•´ç†ã—ã¦ã¿ã¾ã™ã€‚
ã©ã†ã—ã¦ã‚‚ã‚³ãƒ”ãƒ¼ã‚’è¿½ã‚ãªã„ã¨ã„ã‘ãªã„æ™‚ã«å½¹ç«‹ã¤ã“ã¨ã‚’é¡˜ã„ã¤ã¤ã€ãƒã‚¤ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ›¸ãå§‹ã‚ã‚‹ãã£ã‹ã‘ã«ãªã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

# ã“ã®è¨˜äº‹ã§æ‰±ã†ã“ã¨

ã‚³ãƒ”ãƒ¼é–¢é€£ã§æ··ä¹±ã—ãŒã¡ãªå•é¡Œã¨ã—ã¦ä»¥ä¸‹3ã¤ã‚’æ‰±ã„ã¾ã™ã€‚

1. **ã„ã¤ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã‹ï¼Ÿ** â†’ ã‚³ãƒ”ãƒ¼ãŒèµ·ãã‚‹å ´é¢ã¯å¤§ãã2ç¨®é¡ã‚ã‚‹ï¼ˆã‚³ãƒ”ãƒ¼æ§‹ç¯‰ / ä»£å…¥ï¼‰
2. **ã‚³ãƒ”ãƒ¼ã¯ã©ã†ã‚„ã£ã¦è¡Œã‚ã‚Œã‚‹ã‹ï¼Ÿ** â†’ ã‚³ãƒ”ãƒ¼ã®ä»•çµ„ã¿ãŒ3ç¨®é¡ã‚ã‚‹ï¼ˆãƒ“ãƒƒãƒˆã‚³ãƒ”ãƒ¼ + Postblit / Copy Constructor / opAssignï¼‰
3. **ã‚³ãƒ”ãƒ¼é–¢é€£è¦ç´ ã®é–¢ä¿‚æ€§ã¨è½ã¨ã—ç©´** â†’ ãã‚Œãã‚Œã®ç«¶åˆé–¢ä¿‚ï¼ˆäº‹æƒ…ï¼‰ã¨è­¦å‘Šã¸ã®å¯¾å‡¦

`opAssign` ã¯ä»£å…¥ã«é–¢ã™ã‚‹æ¼”ç®—å­ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã§ã‚³ãƒ”ãƒ¼ã«ç›´æ¥é–¢ä¿‚ãªã„ã‚ˆã†ã«è¦‹ãˆã¾ã™ãŒã€ä»–ã®è¦ç´ ã¨ç¶ºéº—ã«å¯¾æ¯”ã§ãã‚‹ã®ã§ã€ã“ã“ã§ã¯ã‚³ãƒ”ãƒ¼é–¢é€£è¦ç´ ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚

ä»¥ä¸‹ã§ãã‚Œãã‚Œæ•´ç†ã—ã¤ã¤ã€è©¦ã—ã¦ã„ã‚‹ã¨å¼•ã£ã‹ã‹ã‚‹è­¦å‘Šã¨å¯¾å‡¦ã«ã¤ã„ã¦ã‚‚è»½ãè§¦ã‚Œã¾ã™ã€‚

# tl;dr

* ã‚³ãƒ”ãƒ¼ãŒèµ·ãã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ã—ã¦ **ã‚³ãƒ”ãƒ¼æ§‹ç¯‰ã¨ä»£å…¥** ãŒã‚ã‚‹
  * ã‚³ãƒ”ãƒ¼æ§‹ç¯‰ï¼šæ—¢å­˜ã®å€¤ã‚’å…ƒã«æ–°ã—ã„å¤‰æ•°ã‚’æ§‹ç¯‰ã™ã‚‹ã¨ãï¼ˆ`auto b = a;`ã€å€¤æ¸¡ã—å¼•æ•°ã€å€¤å‹ã® `return`ï¼‰
  * ä»£å…¥ï¼šã™ã§ã«ã‚ã‚‹å¤‰æ•°ã«å€¤ã‚’å…¥ã‚Œã‚‹ã¨ãï¼ˆ`b = a;` ã‚„ `obj.x = a;`ï¼‰
* **ã‚³ãƒ”ãƒ¼å‡¦ç†ã®ä¸­èº«** ã¯ã„ãã¤ã‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹
  * ãŸã ã®ãƒ“ãƒƒãƒˆã‚³ãƒ”ãƒ¼ï¼šå‹ãŒã‚³ãƒ”ãƒ¼å‡¦ç†ã‚’å®šç¾©ã—ã¦ã„ãªã„å ´åˆã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹ã‚³ãƒ”ãƒ¼å‡¦ç†ãŒä½¿ã‚ã‚Œã€å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾ã—ã¦ãƒ“ãƒƒãƒˆãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ”ãƒ¼ãŒè¡Œã‚ã‚Œã‚‹ã€‚
  * Postblitï¼šãƒ“ãƒƒãƒˆãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ”ãƒ¼å‡¦ç†å¾Œã«å‘¼ã°ã‚Œã‚‹ãƒ•ãƒƒã‚¯å‡¦ç†
    * ä¸»ãªæ›¸ãæ–¹ï¼š`this(this) { ... }`
    * ç‰¹å¾´ï¼šåˆæœŸåŒ–ã§ã‚‚ä»£å…¥ã§ã‚‚å‘¼ã°ã‚Œã‚‹ã€‚ã‚³ãƒ”ãƒ¼å…ƒã‚’å¼•æ•°ã«å–ã‚Œãšã€ã‚³ãƒ”ãƒ¼å¾Œã® `this` ã‚’æ‰±ã†ã€‚
    * è£œè¶³ï¼šå‚ç…§ã‚«ã‚¦ãƒ³ãƒˆã‚„ãƒãƒƒãƒ•ã‚¡ã®è¤‡è£½ãªã©é »å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä½¿ãˆã‚‹ã€‚`@disable this(this)` ã§ã‚³ãƒ”ãƒ¼è‡ªä½“ã‚’ç„¡åŠ¹åŒ–ã§ãã‚‹ã€‚
  * Copy Constructorï¼šã‚³ãƒ”ãƒ¼æ™‚ã«å‘¼ã°ã‚Œã‚‹å‡¦ç†
    * ä¸»ãªæ›¸ãæ–¹ï¼š`this(ref T obj) { }`ã€`this(ref return scope T obj) { }` ãªã©
    * ç‰¹å¾´ï¼šãƒ“ãƒƒãƒˆãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ”ãƒ¼ã‚’ä¼´ã‚ãšã€ã‚³ãƒ”ãƒ¼å…ƒã‚’å¼•æ•°ã«å–ã£ã¦ã‚³ãƒ”ãƒ¼å‡¦ç†å…¨ä½“ã‚’è¨­è¨ˆã§ãã‚‹ã€‚
  * opAssignï¼šä»£å…¥æ™‚ã«å‘¼ã°ã‚Œã‚‹å‡¦ç†
    * ä¸»ãªæ›¸ãæ–¹ï¼š`ref T opAssign(ref T rhs) { }` ãªã©
    * ç‰¹å¾´ï¼šãƒ“ãƒƒãƒˆãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ”ãƒ¼ã‚’ä¼´ã‚ãšã€ä»£å…¥å…ƒã‚’å¼•æ•°ã«å–ã£ã¦ä»£å…¥å‡¦ç†å…¨ä½“ã‚’è¨­è¨ˆã§ãã‚‹ã€‚
* **é–¢ä¿‚æ€§ã¨è½ã¨ã—ç©´**
  * åŒã˜å‹ã« **postblit ã¨ copy ctor ã‚’ä¸¡æ–¹æ›¸ãã¨ postblit ãŒå„ªå…ˆ**ã€‚copy ctor ã‚’ä½¿ã„ãŸã„ãªã‚‰ `@disable this(this)`ã€‚
  * åŒã˜å‹ã« **postblit ã¨ `opAssign` ã‚’ä¸¡æ–¹æ›¸ãã¨ `opAssign` ãŒå„ªå…ˆ**ã€‚Postblitã‚’æ´»ã‹ã—ãŸã„ãªã‚‰ `opAssign` ã‚’ä½¿ã‚ãªã„ã€‚ãã†ã§ãªã‘ã‚Œã° `opAssign` å†…ã§ Postblit ç›¸å½“ã®å‡¦ç†ã‚’æ›¸ãã€‚
  * **ãƒ¡ãƒ³ãƒç”±æ¥ã®PostblitãŒè¦ªã®copy ctorã‚’éš ã™**ã¨ãã¯è­¦å‘ŠãŒå‡ºã‚‹ã€‚
  * å‡ºãŸã‚‰3æŠã§æ„æ€æ±ºå®šï¼š
    1. **copy ctor ã‚’ä½¿ã„ãŸã„** â†’ è¦ªã§ `@disable this(this)`
    2. **postblit ã‚’ä½¿ã„ãŸã„** â†’ è¦ªã§ `this(this)` ã‚’æ˜ç¤º
    3. **ç”Ÿæˆpostblitã§ååˆ†** â†’ è¦ªã® copy ctor ã‚’æ¶ˆã™

# ã„ã¤ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã‹ï¼Ÿ

ã‚³ãƒ”ãƒ¼ãŒèµ·ãã‚‹å ´é¢ã¯å¤§ãã2ç¨®é¡ã‚ã‚Šã¾ã™ã€‚

1. **ã‚³ãƒ”ãƒ¼æ§‹ç¯‰ï¼ˆcopy constructionï¼‰**ï¼šã‚ã‚‹å€¤ã‚’å…ƒã«æ–°ã—ã„å¤‰æ•°ã‚’ä½œã‚‹ã¨ã
2. **ä»£å…¥ï¼ˆassignmentï¼‰**ï¼šã™ã§ã«ã‚ã‚‹å¤‰æ•°ã«å€¤ã‚’å…¥ã‚Œã‚‹ã¨ã

## ã‚³ãƒ”ãƒ¼æ§‹ç¯‰ï¼ˆcopy constructionï¼‰

ã€Œã‚ã‚‹å€¤ã‚’å…ƒã«æ–°ã—ã„å¤‰æ•°ã‚’ä½œã‚‹ã€ã¨ã„ã†æ„å‘³ã‚’æŒã£ãŸæ§‹æ–‡ãŒè©²å½“ã—ã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®3ã¤ã®å ´åˆãŒè©²å½“ã—ã¾ã™ã€‚

* å¤‰æ•°å®£è¨€ï¼š`auto b = a;` ï¼ˆ`b` ã¯ `a` ã®ã‚³ãƒ”ãƒ¼ã§åˆæœŸåŒ–ã•ã‚Œã‚‹ï¼‰
* å€¤æ¸¡ã—å¼•æ•°ï¼š`void fun(T x)` ã«å¯¾ã™ã‚‹ `fun(a)` ï¼ˆ`x` ã¯ `a` ã®ã‚³ãƒ”ãƒ¼ã§åˆæœŸåŒ–ã•ã‚Œã‚‹ï¼‰
* å€¤å‹ã® `return`ï¼š`return a;`ï¼ˆå€¤ã‚’è¿”ã™å…ˆãŒ `a` ã®ã‚³ãƒ”ãƒ¼ã§åˆæœŸåŒ–ã•ã‚Œã‚‹ï¼‰

ãªãŠã€ã“ã®ã‚³ãƒ”ãƒ¼æ§‹ç¯‰ã¯å˜ãªã‚‹å¤‰æ•°å®£è¨€ï¼ˆ`T obj = T();`ï¼‰ã‚„ `fun(T());`ã®ã‚ˆã†ãªé–¢æ•°å‘¼ã³å‡ºã—ã‚’å«ã¿ã¾ã›ã‚“ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚

ã¾ãŸã€ã“ã‚Œã‚‰ã¯NVROï¼ˆNamed Return Value Optimizationï¼‰ã«ã‚ˆã‚Šã‚³ãƒ”ãƒ¼ãŒçœç•¥ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
NVROï¼ˆNamed Return Value Optimizationï¼‰ã¯å…ƒã€…C++ç”¨èªã§ã™ã®ã§ã€è©³ã—ãã¯[C++ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã®è¨˜äº‹](https://cpprefjp.github.io/lang/cpp17/guaranteed_copy_elision.html)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
ã“ã“ã§ã¯ä¸€æ—¦ç„¡ã„ã‚‚ã®ã¨ã—ã¦è©±ã‚’é€²ã‚ã¾ã™ã€‚


ã“ã‚Œã«å¯¾ã—ã¦ã‚³ãƒ”ãƒ¼ãŒç™ºç”Ÿã—ãªã„é¡ä¼¼ã®æ§‹æ–‡ã«ã¯ä»¥ä¸‹ãŒã‚ã‚Šã¾ã™ã€‚

* å‚ç…§å¤‰æ•°ã®æ§‹ç¯‰ï¼š`ref T b = a;` ï¼ˆ[dmd 2.111ä»¥é™ã§å¯èƒ½](https://qiita.com/lempiji/items/ccc639825a64bc149659#%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%82%AF%E3%83%A9%E3%82%B9-ref-%E3%81%A8-auto-ref-%E3%81%8C%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E5%A4%89%E6%95%B0%E9%9D%99%E7%9A%84%E5%A4%89%E6%95%B0extern-%E5%A4%89%E6%95%B0%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E5%A4%89%E6%95%B0%E3%81%AB%E3%82%82%E9%81%A9%E7%94%A8%E5%8F%AF%E8%83%BD%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%97%E3%81%9F)ã€‚`b` ã¯ `a` ã®å‚ç…§ã‚’æŒ‡ã™ã ã‘ã§ã‚³ãƒ”ãƒ¼ã¯èµ·ããªã„ï¼‰
* å‚ç…§æ¸¡ã—å¼•æ•°ï¼š`fun(ref a)`
* ãƒã‚¤ãƒ³ã‚¿æ¸¡ã—å¼•æ•°ï¼š`fun(&a)`
* return by refï¼š`ref T foo()` ã«ãŠã‘ã‚‹ `return a;` ï¼ˆæ›¸ãæ–¹ã¯åŒã˜ã§ã‚‚ã€è¿”ã•ã‚Œã‚‹ã®ã¯ `a` ã®å‚ç…§ãªã®ã§ã‚³ãƒ”ãƒ¼ã¯èµ·ããªã„ï¼‰


## ä»£å…¥ï¼ˆassignmentï¼‰

ã€Œã™ã§ã«ã‚ã‚‹å¤‰æ•°ã«å€¤ã‚’å…¥ã‚Œã‚‹ã€ã¨ã„ã†æ„å‘³ã‚’æŒã£ãŸæ§‹æ–‡ãŒè©²å½“ã—ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã‚Œã°é »å‡ºã® `b = a;` ãŒè©²å½“ã—ã¾ã™ã€‚
ã‚ã‚‹æ§‹é€ ä½“ã‚„ã‚¯ãƒ©ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸€éƒ¨ã‚’æ›¸ãæ›ãˆã‚‹å ´åˆï¼ˆ`obj.x = a;` ãªã©ï¼‰ã‚‚åŒæ§˜ã§ã™ã€‚

# ã‚³ãƒ”ãƒ¼å‡¦ç†

## æ—¢å®šã®ã‚³ãƒ”ãƒ¼å‡¦ç†

Dè¨€èªã§ã¯ã€**å‹ãŒã‚³ãƒ”ãƒ¼å‡¦ç†ã‚’å®šç¾©ã—ã¦ã„ãªã„å ´åˆã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒè‡ªå‹•çš„ã«ç”Ÿæˆã™ã‚‹ã‚³ãƒ”ãƒ¼å‡¦ç†**ãŒä½¿ã‚ã‚Œã¾ã™ã€‚
ã“ã®ã¨ãã€**å‹ã®å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¯¾ã—ã¦ãƒ“ãƒƒãƒˆãƒ¬ãƒ™ãƒ«ã®ã‚³ãƒ”ãƒ¼ï¼ˆblitï¼‰ãŒè¡Œã‚ã‚Œã‚‹** ã¨ã„ã†ã®ãŒåŸºæœ¬ã§ã™ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒpostblitã‚’æŒã£ã¦ã„ã‚Œã°ãã‚Œã‚’å‘¼ã‚“ã ã‚Šã‚‚ã—ã¾ã™ã€‚

## Postblitï¼ˆ`this(this)`ï¼‰

Postblit ã¯ã€Œ**ã‚³ãƒ”ãƒ¼æ§‹ç¯‰ï¼ˆcopy constructionï¼‰ã¨ä»£å…¥ï¼ˆassignmentï¼‰ã®ç›´å¾Œã«èµ°ã‚‹å…±é€šã®ãƒ•ãƒƒã‚¯å‡¦ç†**ã€ã§ã™ã€‚
ä»•æ§˜ã¯ä»¥ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚

https://dlang.org/spec/struct.html#struct-postblit

Postblit ã‚’å®šç¾©ã™ã‚‹ã¨ã€ã‚³ãƒ”ãƒ¼ã¯ä»¥ä¸‹ã®2ã‚¹ãƒ†ãƒƒãƒ—ã§è¡Œã‚ã‚Œã¾ã™ã€‚

1. ã‚³ãƒ”ãƒ¼å…ƒã¨ã‚³ãƒ”ãƒ¼å…ˆã®é–“ã§ **ãƒ“ãƒƒãƒˆã‚³ãƒ”ãƒ¼ï¼ˆblitï¼‰** ãŒè¡Œã‚ã‚Œã‚‹ï¼ˆæ—¢å®šã®ã‚³ãƒ”ãƒ¼å‡¦ç†ï¼‰
2. **ã‚³ãƒ”ãƒ¼å¾Œã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦**ã€Postblitï¼ˆ`this(this)`ï¼‰ ãŒå‘¼ã°ã‚Œã‚‹


å…¸å‹ä¾‹ï¼šå‹•çš„é…åˆ—ã‚’ deep copy ã™ã‚‹ã€‚

```d
struct P {
  int[] buffer;
  this(this) {
    // blitã ã‘ã§ã¯åŒã˜é…åˆ—å‚ç…§ã‚’æŒ‡ã—ã¦ã—ã¾ã†ã®ã§ä¿®å¾©
    buffer = buffer.dup;
  }
}

void main() {
  auto p = P();
  p.buffer = [1, 2, 3];

  auto q = p; // ã“ã“ã§ Postblit ãŒå‘¼ã°ã‚Œã‚‹
}
```

> `Post-blit` ã® `blit` ã¨ã¯ï¼Ÿ => [Bit Block Transfer](https://ja.wikipedia.org/wiki/Bit_Block_Transfer) ã®ç•¥ã€‚ãƒ¡ãƒ¢ãƒªã®å†…å®¹ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã™ã‚‹æ“ä½œã®ã“ã¨ã€‚


## Copy Constructorï¼ˆ`this(ref T obj)`ã€`this(ref return scope T obj)` ãªã©ï¼‰

ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã¯ã€Postblitã«å¯¾ã—ã¦ **ãƒ“ãƒƒãƒˆã‚³ãƒ”ãƒ¼ã‚’ä¼´ã‚ãªã„ã‚³ãƒ”ãƒ¼å‡¦ç†å…¨ä½“ã‚’æ‰±ã†å®šç¾©** ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
ä»•æ§˜ã¯ä»¥ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚

https://dlang.org/spec/struct.html#struct-copy-constructor

ã‚³ãƒ”ãƒ¼ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

* ã‚³ãƒ”ãƒ¼å…ƒï¼ˆ`rhs`ï¼‰ã¨ã‚³ãƒ”ãƒ¼å…ˆï¼ˆ`this`ï¼‰ã‚’ä¸¡æ–¹æ‰±ãˆã‚‹
* æ—¢å®šã®ã‚³ãƒ”ãƒ¼å‡¦ç†ã‚’ä»‹ã•ãšã€**ã‚³ãƒ”ãƒ¼å‡¦ç†ã‚’ã™ã¹ã¦è¨­è¨ˆã§ãã‚‹**

å…¸å‹ä¾‹ï¼šå‹•çš„é…åˆ—ã‚’ deep copy ã™ã‚‹ã€‚

```d
struct C {
  int[] buffer;

  // Copy Constructorã®å®šç¾©
  this(ref return scope C rhs) {
    buffer = rhs.buffer.dup;
  }
}

void main() {
  auto c = C();
  c.buffer = [1, 2, 3];

  auto d = c; // ã“ã“ã§ Copy Constructor ãŒå‘¼ã°ã‚Œã‚‹
}
```

## opAssignï¼ˆ`ref T opAssign(ref T rhs)`ï¼‰

`opAssign` ã¯ **ä»£å…¥ï¼ˆassignmentï¼‰ã®ã¨ãã«å‘¼ã°ã‚Œã‚‹å‡¦ç†** ã‚’å®šç¾©ã—ã¾ã™ã€‚
ä»•æ§˜ã¨ã—ã¦ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

https://dlang.org/spec/operatoroverloading.html#assignment

æ¼”ç®—å­ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã®ä¸€ç¨®ãªã®ã§ã‚³ãƒ”ãƒ¼åˆ¶å¾¡ã«ä¼¼ã¤ã‹ã‚ã—ããªã„æ°—ã‚‚ã™ã‚‹ã®ã§ã™ãŒã€Copy Constructorã¨å¯¾æ¯”çš„ã«è¦‹ã¦ã„ãã¨éå¸¸ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
é•ã„ã‚‚ã»ã¨ã‚“ã©ãªãã€è¦‹ãŸç›®çš„ã«ã¯é–¢æ•°ã®ã‚·ã‚°ãƒãƒãƒ£ã‚„æˆ»ã‚Šå€¤ã®æœ‰ç„¡ãŒã¡ã‚‡ã£ã¨é•ã†ãã‚‰ã„ã§æ›¸ãã“ã¨ã¯å¤§æŠµåŒã˜ã§ã™ã€‚

å…¸å‹ä¾‹ï¼šå‹•çš„é…åˆ—ã‚’ deep copy ã™ã‚‹ã€‚

```d
struct A {
  int[] buffer;

  // ä»£å…¥å‡¦ç†ï¼ˆopAssignï¼‰ã®å®šç¾©
  ref A opAssign(ref A rhs) {
    buffer = rhs.buffer.dup;
    return this;
  }
}

void main() {
  auto a1 = A();
  a1.buffer = [1, 2, 3];

  auto a2 = A();
  a2 = a1; // ã“ã“ã§ opAssign ãŒå‘¼ã°ã‚Œã‚‹
}
```

# ã‚³ãƒ”ãƒ¼å‡¦ç†ã®é–¢ä¿‚æ€§ã¨è½ã¨ã—ç©´

## postblit ã¨ copy ctor ã®é–¢ä¿‚

åŒã˜å‹ã« **postblit ã¨ copy ctor ã‚’ä¸¡æ–¹æ›¸ãã¨ postblit ãŒå„ªå…ˆ** ã•ã‚Œã¾ã™ã€‚
ã¤ã¾ã‚Šã€copy ctor ã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚
ã‚‚ã— copy ctor ã‚’ä½¿ã„ãŸã„ãªã‚‰ã€**postblit ã‚’ç„¡åŠ¹åŒ–**ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```d
struct S {
  this(this) { writeln("S.postblit"); }
  this(ref S rhs) { writeln("S.copyctor"); }
}

void main() {
  auto s1 = S();
  auto s2 = s1; // S.postblit ãŒå‘¼ã°ã‚Œã‚‹
}
```

å¯¾ç­–ï¼š`@disable this(this)` ã§ postblit ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã€‚

```d
struct S {
  @disable this(this); // postblit ç„¡åŠ¹åŒ–
  this(ref S rhs) { writeln("S.copyctor"); }
}

void main() {
  auto s1 = S();
  auto s2 = s1; // S.copyctor ãŒå‘¼ã°ã‚Œã‚‹
}
```

## postblit ã¨ opAssign ã®é–¢ä¿‚
åŒã˜å‹ã« **postblit ã¨ `opAssign` ã‚’ä¸¡æ–¹æ›¸ããã¨ `opAssign` ãŒå„ªå…ˆ** ã•ã‚Œã¾ã™ã€‚
ã¤ã¾ã‚Šã€postblit ã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚

ã‚‚ã— postblit ã‚’æ´»ã‹ã—ãŸã„ãªã‚‰ã€**`opAssign` ã‚’ä½¿ã‚ãªã„**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã†ã§ãªã‘ã‚Œã°ã€`opAssign` å†…ã§ Postblit ç›¸å½“ã®å‡¦ç†ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```d
struct T {
  this(this) { writeln("T.postblit"); }
  ref T opAssign(ref const(T) rhs) {
    writeln("T.opAssign");
    return this;
  }
}

void main() {
  auto t1 = T();
  auto t2 = T();
  t2 = t1; // T.opAssign ãŒå‘¼ã°ã‚Œã‚‹
}
```

å¯¾ç­–1ï¼š`opAssign` ã‚’ä½¿ã‚ãªã„ã€‚

```d
struct T {
  this(this) { writeln("T.postblit"); }
}

void main() {
  auto t1 = T();
  T t2;
  t2 = t1; // T.postblit ãŒå‘¼ã°ã‚Œã‚‹
}
```

å¯¾ç­–2ï¼š`opAssign` å†…ã§ Postblit ç›¸å½“ã®å‡¦ç†ã‚’æ›¸ãã€‚

```d
struct T {
  this(this) { writeln("T.postblit"); }
  ref T opAssign(ref const(T) rhs) {
    writeln("T.opAssign");
    // Postblit ç›¸å½“ã®å‡¦ç†ã‚’æ›¸ã
    return this;
  }
}

void main() {
  auto t1 = T();
  auto t2 = T();
  t2 = t1; // T.opAssignã®ä¸­ã§postblitç›¸å½“ã®å‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹
}
```

## ãƒ¡ãƒ³ãƒç”±æ¥ã®PostblitãŒè¦ªã®copy ctorã‚’éš ã™

ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ postblit ã‚’æŒã¤ã¨ã€å¤–å´ã« **è‡ªå‹•çš„ã«postblit**ï¼ˆå­ã®postblitã‚’å‘¼ã¶ï¼‰ ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
ãã®çµæœPostblitã¨Copy Constructorã®å„ªå…ˆåº¦é–¢ä¿‚ã‹ã‚‰ã€ã€Œå¤–å´ã« copy ctor ã‚’æ›¸ã„ãŸã®ã«å‘¼ã°ã‚Œãªã„ã€çŠ¶æ…‹ã«ãªã‚Šå¾—ã¾ã™ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```d
struct A { this(this) {} } // A ã¯ postblit ã‚’æŒã¤
struct B {
  A a; // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ a ãŒ postblit ã‚’æŒã¤
  this(ref const(B) rhs) {} // B ã« copy ctor ã‚’å®šç¾©
}
```

ã¡ãªã¿ã«ã“ã‚Œã¯è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã¾ã™ã€‚éæ¨å¥¨ã¯ã„ã¤ã‹æ¶ˆãˆã‚‹ã®ã§æ°—ã‚’ä»˜ã‘ã¾ã—ã‚‡ã†ã€‚

è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:

```text
Deprecation: `struct B` implicitly-generated postblit hides copy constructor.
The field postblit will have priority over the copy constructor.
To change this, the postblit should be disabled for `struct B`
```

**ã“ã®è­¦å‘ŠãŒå‡ºãŸã‚‰3æŠ**ã§ã™ã€‚ã©ã‚ŒãŒæ­£ã—ã„ã‹ã¯è¨­è¨ˆæ¬¡ç¬¬ã€‚

* è¦ªã§ **copy ctor ã‚’ä½¿ã„ãŸã„** â†’ `@disable this(this)`
* è¦ªã§ **postblit ã‚’ä½¿ã„ãŸã„** â†’ `this(this)` ã‚’æ˜ç¤º
* **ç”Ÿæˆã•ã‚ŒãŸpostblitã§ååˆ†** â†’ copy ctor ã‚’æ¶ˆã™

```d
struct A { this(this) {} }

// è­¦å‘ŠãŒå‡ºã‚‹å½¢
struct B {
  A a;
  this(ref const(B) rhs) {}
}

// 1) copy ctor ã‚’ä½¿ã„ãŸã„ â†’ postblit disable
struct B1 {
  A a;
  @disable this(this);
  this(ref const(B1) rhs) {}
}

// 2) postblit ã‚’ä½¿ã„ãŸã„ â†’ postblit æ˜ç¤º
struct B2 {
  A a;
  this(this) {}
  this(ref const(B2) rhs) {}
}

// 3) ç”Ÿæˆpostblitã§ååˆ† â†’ copy ctor ã‚’æ¶ˆã™
struct B3 {
  A a;
}
```


# ã¾ã¨ã‚

ã‚³ãƒ”ãƒ¼ãŒã„ã¤èµ·ãã‚‹ã®ã‹ï¼Ÿã‚³ãƒ”ãƒ¼ã¯ã©ã®ã‚ˆã†ã«è¡Œã‚ã‚Œã‚‹ã®ã‹ï¼Ÿã¨ã„ã†ã¨åˆ†ã‹ã‚Šã¥ã‚‰ã„ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã€ç°¡å˜ã«æ•´ç†ã—ã¦ã¿ã¾ã—ãŸã€‚

ã‚³ãƒ”ãƒ¼ã«é–¢é€£ã™ã‚‹è¦ç´ ã¯å¤šã„ã§ã™ãŒã€éª¨æ ¼ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚
ãƒã‚¤ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããŸã„å ´åˆã€ã¾ãšã¯ã€Œã‚³ãƒ”ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ã€ã¨ã„ã†æ°—æŒã¡ã§ä»Šå›ã®å†…å®¹ã‚’æ€ã„å‡ºã—ã¦ã¿ã¦ãã ã•ã„ã€‚

1. ã€Œ**ã‚³ãƒ”ãƒ¼æ§‹ç¯‰ã‚„ä»£å…¥**ã€ã‚’æ¢ã™ï¼ˆã“ã“ãŒ9å‰²ï¼‰
2. åˆæœŸåŒ–ãªã‚‰ã€Œpostblit / copy ctor ã®ã©ã‚ŒãŒå‹•ãã‹ã€ï¼ˆã©ã‚ŒãŒä½¿ãˆã‚‹ã‹ï¼‰ã‚’è¦‹ã‚‹
3. ä»£å…¥ãªã‚‰ã€ŒopAssign ã‹æ—¢å®šä»£å…¥ï¼ˆã¤ã¾ã‚Špostblitã‚ã‚‹ã„ã¯copy ctorï¼‰ã‹ã€ï¼ˆã©ã‚ŒãŒä½¿ãˆã‚‹ã‹ï¼‰ã‚’è¦‹ã‚‹
4. å¯¾å¿œã®éç¨‹ã§è½ã¨ã—ç©´ï¼ˆè­¦å‘Šï¼‰ã«ãƒãƒã‚Šã‹ã‘ãŸã‚‰å¯¾ç­–ã‚’3æŠã®ä¸­ã‹ã‚‰æ±ºã‚ã¦å¯¾å‡¦ã™ã‚‹

ã¡ãªã¿ã«Dè¨€èªã«ã¯ã‚³ãƒ”ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚ã®ãƒ ãƒ¼ãƒ–ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆMove Constructorï¼‰ã‚‚ã‚ã‚Šã€ãã®è¨˜äº‹ã®å‰æ®µã¨ã—ã¦ã“ã®è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚
é¿ã‘ãŸã„ã‚³ãƒ”ãƒ¼ã‚’è¦‹ã¤ã‘ãŸã‚‰ã€ãã‚Œã‚’ã©ã†ãƒ ãƒ¼ãƒ–ã§é¿ã‘ã‚‹ã®ã‹ã€ã¨ã„ã†ã‚ãŸã‚Šã‚’ã¾ã¨ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ä»¥ä¸Šï¼